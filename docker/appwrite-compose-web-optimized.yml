version: '3.8'

# Appwrite Docker Compose Configuration
# Optimized for Web-Based Backend Deployment with Multi-Tenant Support
# Date: January 21, 2026

services:
  # ==================== DATABASE ====================
  mariadb:
    image: mariadb:10.11
    container_name: appwrite-mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-appwrite_root_secure_2026}
      MYSQL_DATABASE: appwrite
      MYSQL_USER: appwrite
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-appwrite_db_secure_2026}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    volumes:
      - /mnt/storage/appwrite/mysql:/var/lib/mysql
    networks:
      - appwrite
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # ==================== CACHE ====================
  redis:
    image: redis:7-alpine
    container_name: appwrite-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - /mnt/storage/appwrite/redis:/data
    networks:
      - appwrite
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==================== APPWRITE MAIN SERVICE ====================
  appwrite:
    image: appwrite/appwrite:1.5
    container_name: appwrite-main
    restart: unless-stopped
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # ===== GENERAL SETTINGS =====
      _APP_ENV: production
      _APP_LOCALE: en
      _APP_SYSTEM_SECURITY_EMAIL_ADDRESS: security@extropos.org
      
      # ===== ENCRYPTION =====
      _APP_OPENSSL_KEY_V1: ${APPWRITE_OPENSSL_KEY:-dbccde1aa2b0b905f3cda5203b070a75e0ee2e04ed215fd3a48462d77e3ab797}
      
      # ===== DOMAIN & URLs =====
      _APP_DOMAIN: ${APPWRITE_DOMAIN:-appwrite.extropos.org}
      _APP_DOMAIN_TARGET: ${APPWRITE_DOMAIN:-appwrite.extropos.org}
      _APP_DOMAIN_FUNCTIONS: ${APPWRITE_DOMAIN:-appwrite.extropos.org}
      
      # ===== CORS & SECURITY (Web-Optimized) =====
      _APP_OPTIONS_ABUSE: ${APPWRITE_DISABLE_ABUSE:-enabled}
      # For local dev/testing, allow HTTP. For production, set to enabled.
      _APP_OPTIONS_FORCE_HTTPS: ${APPWRITE_FORCE_HTTPS:-disabled}
      _APP_OPTIONS_ROUTER_PROTECTION: ${APPWRITE_ROUTER_PROTECTION:-enabled}

      # Console whitelist - allow prod domains plus local admin
      # Temporarily allow root signup for first admin account creation
      _APP_CONSOLE_WHITELIST_ROOT: disabled
      _APP_CONSOLE_WHITELIST_EMAILS: ""
      _APP_CONSOLE_WHITELIST_IPS: ""
      _APP_CONSOLE_WHITELIST_ORIGINS: "https://extropos.org,https://www.extropos.org,http://localhost:8080,http://localhost:3000"
      
      # ===== DATABASE =====
      _APP_DB_HOST: mariadb
      _APP_DB_PORT: 3306
      _APP_DB_SCHEMA: appwrite
      _APP_DB_USER: appwrite
      _APP_DB_PASS: ${MYSQL_PASSWORD:-appwrite_db_secure_2026}
      _APP_DB_ROOT_PASS: ${MYSQL_ROOT_PASSWORD:-appwrite_root_secure_2026}
      
      # ===== REDIS CACHE =====
      _APP_REDIS_HOST: redis
      _APP_REDIS_PORT: 6379
      _APP_REDIS_USER: ""
      _APP_REDIS_PASS: ""
      _APP_REDIS_DB: 0
      
      # ===== EMAIL SETTINGS =====
      _APP_SMTP_HOST: ${SMTP_HOST:-}
      _APP_SMTP_PORT: ${SMTP_PORT:-587}
      _APP_SMTP_SECURE: ${SMTP_SECURE:-tls}
      _APP_SMTP_USERNAME: ${SMTP_USERNAME:-}
      _APP_SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      _APP_SYSTEM_EMAIL_NAME: ${SYSTEM_EMAIL_NAME:-ExtroPOS}
      _APP_SYSTEM_EMAIL_ADDRESS: ${SYSTEM_EMAIL_ADDRESS:-no-reply@extropos.org}
      
      # ===== STORAGE =====
      _APP_STORAGE_LIMIT: ${STORAGE_LIMIT:-30000000000}  # 30GB default
      _APP_STORAGE_PREVIEW_LIMIT: 20000000  # 20MB
      _APP_STORAGE_ANTIVIRUS: disabled  # Disable for performance
      _APP_STORAGE_ANTIVIRUS_HOST: ${ANTIVIRUS_HOST:-clamav}
      _APP_STORAGE_ANTIVIRUS_PORT: ${ANTIVIRUS_PORT:-3310}
      
      # ===== FUNCTIONS =====
      _APP_FUNCTIONS_SIZE_LIMIT: 30000000  # 30MB
      _APP_FUNCTIONS_TIMEOUT: 900  # 15 minutes
      _APP_FUNCTIONS_BUILD_TIMEOUT: 900
      _APP_FUNCTIONS_CPUS: ${FUNCTIONS_CPUS:-1}
      _APP_FUNCTIONS_MEMORY: ${FUNCTIONS_MEMORY:-512}
      _APP_FUNCTIONS_MEMORY_SWAP: ${FUNCTIONS_MEMORY_SWAP:-512}
      _APP_FUNCTIONS_RUNTIMES: node-18.0,php-8.2,python-3.11,dart-3.0
      
      # ===== LOGGING =====
      _APP_LOGGING_PROVIDER: ${LOGGING_PROVIDER:-}
      _APP_LOGGING_CONFIG: ${LOGGING_CONFIG:-}
      
      # ===== PERFORMANCE =====
      _APP_REDIS_MAXTTL: 86400  # 24 hours cache
      _APP_EXECUTOR_SECRET: ${EXECUTOR_SECRET:-your-executor-secret-key}
      
      # ===== WEBHOOKS =====
      _APP_USAGE_STATS: ${USAGE_STATS:-enabled}

    ports:
      - "8080:80"
      - "8443:443"
    volumes:
      - /mnt/storage/appwrite/config:/etc/appwrite
      - /mnt/storage/appwrite/storage:/storage
      - /mnt/storage/appwrite/functions:/storage/functions
      - /mnt/storage/appwrite/builds:/storage/builds
      - /mnt/storage/appwrite/cache:/storage/cache
    networks:
      - appwrite
    healthcheck:
      # Use unauthenticated health endpoint to avoid scope errors
      test: ["CMD", "curl", "-f", "http://localhost/v1/health/version"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==================== MAINTENANCE WORKER ====================
  appwrite-worker-database:
    image: appwrite/appwrite:1.5
    container_name: appwrite-worker-database
    restart: unless-stopped
    depends_on:
      - appwrite
    environment:
      _APP_ENV: production
      _APP_REDIS_HOST: redis
      _APP_REDIS_PORT: 6379
      _APP_DB_HOST: mariadb
      _APP_DB_PORT: 3306
      _APP_DB_SCHEMA: appwrite
      _APP_DB_USER: appwrite
      _APP_DB_PASS: ${MYSQL_PASSWORD:-appwrite_db_secure_2026}
    command: worker-database
    networks:
      - appwrite

  # ==================== FUNCTIONS WORKER ====================
  appwrite-worker-functions:
    image: appwrite/appwrite:1.5
    container_name: appwrite-worker-functions
    restart: unless-stopped
    depends_on:
      - appwrite
    environment:
      _APP_ENV: production
      _APP_REDIS_HOST: redis
      _APP_REDIS_PORT: 6379
      _APP_DB_HOST: mariadb
      _APP_DB_PORT: 3306
      _APP_DB_SCHEMA: appwrite
      _APP_DB_USER: appwrite
      _APP_DB_PASS: ${MYSQL_PASSWORD:-appwrite_db_secure_2026}
      _APP_EXECUTOR_SECRET: ${EXECUTOR_SECRET:-your-executor-secret-key}
    command: worker-functions
    volumes:
      - /mnt/storage/appwrite/functions:/storage/functions
      - /mnt/storage/appwrite/builds:/storage/builds
    networks:
      - appwrite

networks:
  appwrite:
    driver: bridge
    name: appwrite-network

volumes:
  mysql-data:
  redis-data:
  appwrite-storage:
  appwrite-functions:
