version: '3.8'

services:
  # ==========================================
  # PROXY - Simple proxy to match tunnel expectations
  # ==========================================
  proxy-service:
    image: nginx:alpine
    container_name: flutterpos-proxy
    restart: unless-stopped
    networks:
      appwrite:
        ipv4_address: 172.20.0.100
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - traefik
  traefik:
    # Pin to a stable patch version to ensure reproducible deployments.
    # We used 'latest' while testing; pinning to a specific release avoids
    # unexpected behavior when new minor/patch releases appear.
    # Use a reproducible and human-friendly tag for Traefik. Keeping `v3.0`
    # keeps behavior stable while referencing a clear release line.
    # Use the 'latest' tag which is currently known-good for this environment
    # (this mirrors the image we tested earlier). You may choose a specific
    # pinned tag later once you confirm compatibility.
    # Pin to an exact image digest for reproducible deployments.
    # Pulled digest: sha256:c5bd185c41ba3dbb42cf8a1b9fbdc368bdc96f90c8e598134879935f64e7a7f1
    image: traefik@sha256:c5bd185c41ba3dbb42cf8a1b9fbdc368bdc96f90c8e598134879935f64e7a7f1
    container_name: flutterpos-traefik
    restart: unless-stopped
    command:
      - "--api=true"
      - "--log.level=DEBUG"
      - "--api.dashboard=true"
      - _APP_DOMAIN_TARGET=localhost
      - _APP_CONSOLE_WHITELIST_DOMAINS=localhost,appwrite.extropos.org,backend.extropos.org,api.extropos.org,extropos.org
      - _APP_CONSOLE_WHITELIST_ROOT=disabled
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--accesslog=true"
      - "--metrics.prometheus=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare"
      # Use staging CA for testing to avoid production rate limits; remove for production
      - "--certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
      - "--certificatesresolvers.letsencrypt.acme.email=${EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--providers.file.directory=/etc/traefik/dynamic"
    ports:
      - "80:80"
      - "443:443"
      - "8081:8080"  # Traefik dashboard
    environment:
      - CLOUDFLARE_API_TOKEN=${CF_API_TOKEN}
      # Traefik v3 ACME Cloudflare provider expects one of the following
      # environment variables. Ensure a DNS API token is available to
      # allow Traefik to complete DNS challenges.
      - CLOUDFLARE_DNS_API_TOKEN=${CF_API_TOKEN}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
    networks:
      - proxy
      - appwrite
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.middlewares=auth"
      # The traefik dashboard hostname may not have DNS records in all
      # environments. Avoid automatic ACME certificate issuance when the
      # hostname isn't present by omitting the certresolver here.
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$2y$$10$$..."

  # ==========================================
  # APPWRITE - Backend API & Database
  # ==========================================
  appwrite:
    image: appwrite/appwrite:1.5.7
    container_name: flutterpos-appwrite
    restart: unless-stopped
    environment:
      - _APP_ENV=production
      - _APP_LOCALE=en
      - _APP_DOMAIN=localhost
      - _APP_DOMAIN_TARGET=localhost
      - _APP_CONSOLE_WHITELIST_DOMAINS=localhost,appwrite.extropos.org,backend.extropos.org,api.extropos.org,extropos.org
      - _APP_CONSOLE_WHITELIST_ROOT=disabled
      - _APP_CONSOLE_WHITELIST_EMAILS=
      - _APP_CONSOLE_WHITELIST_IPS=
      - _APP_SYSTEM_EMAIL_NAME=FlutterPOS
      - _APP_SYSTEM_EMAIL_ADDRESS=noreply@localhost
      - _APP_SYSTEM_SECURITY_EMAIL_ADDRESS=security@localhost
      - _APP_SYSTEM_RESPONSE_FORMAT=html
      - _APP_OPTIONS_ABUSE=enabled
      - _APP_OPTIONS_FORCE_HTTPS=disabled
      - _APP_OPTIONS_FUNCTIONS_FORCE_HTTPS=disabled
      - _APP_OPTIONS_ROUTER_PROTECTION=disabled
      - _APP_OPTIONS_ROUTER_SECURITY=disabled
      - _APP_OPTIONS_ROUTER_DEBUG=disabled
      - _APP_OPTIONS_FUNCTIONS_TIMEOUT=900
      - _APP_OPTIONS_FUNCTIONS_BUILD_TIMEOUT=900
      - _APP_OPTIONS_FUNCTIONS_CONTAINERS=10
      - _APP_OPTIONS_FUNCTIONS_CPUS=0.5
      - _APP_OPTIONS_FUNCTIONS_MEMORY=512
      - _APP_OPTIONS_FUNCTIONS_MEMORY_SWAP=512
      - _APP_OPTIONS_FUNCTIONS_RUNTIMES=node-18.0,node-17.0,node-16.0,php-8.1,php-8.0,python-3.9,ruby-3.0
      - _APP_OPTIONS_FUNCTIONS_INACTIVE_THRESHOLD=60
      - _APP_OPTIONS_MAINTENANCE_RETENTION_EXECUTION=60
      - _APP_OPTIONS_MAINTENANCE_RETENTION_CACHE=60
      - _APP_OPTIONS_MAINTENANCE_RETENTION_ABUSE=60
      - _APP_OPTIONS_MAINTENANCE_RETENTION_AUDIT=60
      - _APP_OPTIONS_MAINTENANCE_RETENTION_USAGE_HOURLY=60
      - _APP_OPTIONS_MAINTENANCE_RETENTION_SCHEDULES=60
      - _APP_SMTP_HOST=mailhog
      - _APP_SMTP_PORT=1025
      - _APP_SMTP_SECURE=tls
      - _APP_SMTP_USERNAME=
      - _APP_SMTP_PASSWORD=
      - _APP_USAGE_STATS=disabled
      - _APP_STORAGE_LIMIT=30000000
      - _APP_STORAGE_PREVIEW_LIMIT=20000000
      - _APP_STORAGE_ANTIVIRUS=disabled
      - _APP_STORAGE_ANTIVIRUS_HOST=clamav
      - _APP_STORAGE_ANTIVIRUS_PORT=3310
      - _APP_DB_HOST=appwrite-mariadb
      - _APP_DB_PORT=3306
      - _APP_DB_SCHEMA=appwrite
      - _APP_DB_USER=root
      - _APP_DB_PASS=Wudl2wpKW74frA85IqXcNITtL1oVpu1p%2Bl749mzN2FA%3D
      - _APP_REDIS_HOST=appwrite-redis
      - _APP_REDIS_PORT=6379
      - _APP_REDIS_USER=
      - _APP_REDIS_PASS=
      - _APP_REDIS_DB=0
      - _APP_INFLUXDB_HOST=appwrite-influxdb
      - _APP_INFLUXDB_PORT=8086
      - _APP_INFLUXDB_USER=
      - _APP_INFLUXDB_PASS=
      - _APP_EXECUTOR_SECRET=11cc04ffd22bde93de372fd45ca395f935e10863bba4f948f2f820fe76cb9f4a
      - _APP_EXECUTOR_RUNTIME_NETWORK=appwrite_runtimes
      - _APP_FUNCTIONS_SIZE_LIMIT=30000000
      - _APP_FUNCTIONS_TIMEOUT=900
      - _APP_FUNCTIONS_BUILD_TIMEOUT=900
      - _APP_FUNCTIONS_CONTAINERS=10
      - _APP_FUNCTIONS_CPUS=0.5
      - _APP_FUNCTIONS_MEMORY=512
      - _APP_FUNCTIONS_MEMORY_SWAP=512
      - _APP_FUNCTIONS_RUNTIMES=node-18.0,node-17.0,node-16.0,php-8.1,php-8.0,python-3.9,ruby-3.0
      - _APP_FUNCTIONS_INACTIVE_THRESHOLD=60
      - _APP_MAINTENANCE_ENABLED=false
      - _APP_MAINTENANCE_INTERVAL=86400
      - _APP_MAINTENANCE_RETENTION_CACHE=2592000
      - _APP_MAINTENANCE_RETENTION_ABUSE=86400
      - _APP_MAINTENANCE_RETENTION_AUDIT=1209600
      - _APP_MAINTENANCE_RETENTION_EXECUTION=1209600
      - _APP_MAINTENANCE_RETENTION_USAGE=1209600
      - _APP_MAINTENANCE_RETENTION_SESSIONS=2592000
    ports:
      - "8082:80"
    volumes:
      - appwrite_uploads:/storage/uploads:rw
      - appwrite_cache:/storage/cache:rw
      - appwrite_config:/storage/config:rw
      - appwrite_certificates:/storage/certificates:rw
      - appwrite_functions:/storage/functions:rw
    depends_on:
      - appwrite-mariadb
      - appwrite-redis
      - appwrite-influxdb
      - appwrite-telegraf
      - appwrite-minio
    networks:
      - appwrite
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.appwrite.rule=Host(`appwrite.${DOMAIN}`) || Host(`localhost`)"
      - "traefik.http.routers.appwrite.service=appwrite_api"
      - "traefik.http.services.appwrite_api.loadbalancer.server.port=80"
      - "traefik.http.routers.appwrite.entrypoints=web"

  # Appwrite Console
  appwrite-console:
    image: appwrite/console:latest
    container_name: flutterpos-appwrite-console
    restart: unless-stopped
    environment:
      - _APP_ENV=production
      - _APP_DOMAIN=localhost
      - _APP_CONSOLE_DISABLE_WARNINGS=false
    ports:
      - "8083:80"
    networks:
      - appwrite
    # labels:  # Disabled to avoid conflicts with new Appwrite setup

  # Appwrite MariaDB
  appwrite-mariadb:
    image: mariadb:11
    container_name: flutterpos-appwrite-mariadb
    restart: unless-stopped
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    volumes:
      - appwrite_mariadb:/var/lib/mysql:Z
    environment:
      - MYSQL_ROOT_PASSWORD=Wudl2wpKW74frA85IqXcNITtL1oVpu1p+l749mzN2FA=
      - MYSQL_DATABASE=appwrite
      - MYSQL_USER=appwrite
      - MYSQL_PASSWORD=Wudl2wpKW74frA85IqXcNITtL1oVpu1p+l749mzN2FA=
    networks:
      - appwrite

  # Appwrite Redis
  appwrite-redis:
    image: redis:7-alpine
    container_name: flutterpos-appwrite-redis
    restart: unless-stopped
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - appwrite_redis:/data:Z
    networks:
      - appwrite

  # Appwrite InfluxDB
  appwrite-influxdb:
    image: influxdb:1.8-alpine
    container_name: flutterpos-appwrite-influxdb
    restart: unless-stopped
    volumes:
      - appwrite_influxdb:/var/lib/influxdb:Z
    networks:
      - appwrite

  # Appwrite Telegraf
  appwrite-telegraf:
    image: appwrite/telegraf:1.4.0
    container_name: flutterpos-appwrite-telegraf
    restart: unless-stopped
    networks:
      - appwrite

  # Appwrite MinIO (Object Storage)
  appwrite-minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    container_name: flutterpos-appwrite-minio
    restart: unless-stopped
    command: minio server /data --console-address ":9001"
    volumes:
      - appwrite_minio:/data:Z
    environment:
      - MINIO_ROOT_USER=minio
      - MINIO_ROOT_PASSWORD=acBJw+V1LvPcxEFnHkUMCTbsJL3PbS4Mf2L0eLseLXE=
      - MINIO_REGION=us-east-1
    networks:
      - appwrite
    # labels:  # Disabled to avoid conflicts

  # ==========================================
  # NEXTCLOUD - Cloud Storage & Backup
  # ==========================================
  nextcloud-db:
    image: mariadb:11
    container_name: flutterpos-nextcloud-db
    restart: unless-stopped
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    volumes:
      - nextcloud_db:/var/lib/mysql:Z
    environment:
      - MYSQL_ROOT_PASSWORD=nextcloud_root_pass_2025
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloud_db_pass_2025
    networks:
      - nextcloud

  nextcloud:
    image: nextcloud:28-apache
    container_name: flutterpos-nextcloud
    restart: unless-stopped
    volumes:
      - nextcloud_data:/var/www/html:Z
    environment:
      - MYSQL_HOST=nextcloud-db
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloud_db_pass_2025
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=admin123
      - NEXTCLOUD_TRUSTED_DOMAINS=localhost cloud.localhost
      - OVERWRITEPROTOCOL=https
      - OVERWRITEHOST=cloud.localhost
    depends_on:
      - nextcloud-db
    networks:
      - nextcloud
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`cloud.localhost`)"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"

  nextcloud-redis:
    image: redis:7-alpine
    container_name: flutterpos-nextcloud-redis
    restart: unless-stopped
    networks:
      - nextcloud

  # ==========================================
  # RABBITMQ - Real-time Sync
  # ==========================================
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: flutterpos-rabbitmq
    restart: unless-stopped
    environment:
      - RABBITMQ_DEFAULT_USER=posadmin
      - RABBITMQ_DEFAULT_PASS=changeme_secure_Wudl2wpKW74frA85IqXcNITtL1oVpu1p+l749mzN2FA=
      - RABBITMQ_DEFAULT_VHOST=/
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq:Z
    networks:
      - rabbitmq
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rabbitmq.rule=Host(`rabbitmq.localhost`)"
      - "traefik.http.services.rabbitmq.loadbalancer.server.port=15672"

  # ==========================================
  # FLUTTERPOS BACKEND - Web Management Interface
  # ==========================================
  # TEMPORARILY DISABLED - needs Flutter web build first
  # flutterpos-backend:
  #   build:
  #     context: ..
  #     dockerfile: docker/Dockerfile.backend
  #   container_name: flutterpos-backend-web
  #   restart: unless-stopped
  #   environment:
  #     - APPWRITE_ENDPOINT=https://appwrite.${DOMAIN}/v1
  #     - APPWRITE_PROJECT_ID=flutterpos
  #     - NEXTCLOUD_URL=https://cloud.${DOMAIN}
  #     - NEXTCLOUD_USERNAME=flutterpos
  #     - NEXTCLOUD_PASSWORD=secure_Wudl2wpKW74frA85IqXcNITtL1oVpu1p+l749mzN2FA=_here
  #   networks:
  #     - proxy
  #     - appwrite
  #     - nextcloud
  #   labels:
  #     - "traefik.enable=true"
  #     # Disabled to avoid conflict with super-admin-api
  #     - "traefik.http.routers.backend.rule=Host(`portal.${DOMAIN}`)"
  #     - "traefik.http.routers.backend.entrypoints=websecure"
  #     - "traefik.http.routers.backend.tls.certresolver=letsencrypt"
  #     - "traefik.http.services.backend.loadbalancer.server.port=80"

  # ==========================================
  # SUPER ADMIN BACKEND API - Tenant Management API
  # ==========================================
  super-admin-api:
    build:
      context: ../backend-api
      dockerfile: Dockerfile
    container_name: flutterpos-super-admin-api
    restart: unless-stopped
    environment:
      - PORT=3001
      - NODE_ENV=production
      - SUPER_ADMIN_API_KEY=${SUPER_ADMIN_API_KEY}
      - ALLOWED_ORIGINS=https://backend.${DOMAIN},https://appwrite.${DOMAIN}
      - ALLOWED_CIDRS=192.168.0.0/24,10.0.0.0/8,172.16.0.0/12
    networks:
      - proxy
      - appwrite
    labels:
      - "traefik.enable=true"
      # HTTP router (disabled to avoid conflicts)
      # - "traefik.http.routers.super-admin-api.rule=Host(`api.${DOMAIN}`)"
      # - "traefik.http.routers.super-admin-api.entrypoints=web"
      # - "traefik.http.routers.super-admin-api.tls=false"
      # - "traefik.http.routers.super-admin-api.middlewares=no-redirect@docker"
      # - "traefik.http.services.super-admin-api.loadbalancer.server.port=3001"
      # Middleware to prevent redirects
      - "traefik.http.middlewares.no-redirect.headers.customRequestHeaders.X-Forwarded-Proto=http"
      # HTTPS router - use api domain for Super Admin API
      - "traefik.http.routers.superadmin-api.rule=Host(`api.${DOMAIN}`)"
      - "traefik.http.routers.superadmin-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.superadmin-api.loadbalancer.server.url=http://flutterpos-super-admin-api:3001"

  # ==========================================
  # MAILHOG - Email Testing (Development)
  # ==========================================
  mailhog:
    image: mailhog/mailhog:latest
    container_name: flutterpos-mailhog
    restart: unless-stopped
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mailhog.rule=Host(`mail.${DOMAIN}`)"
      - "traefik.http.services.mailhog.loadbalancer.server.url=http://flutterpos-mailhog:8025"
      - "traefik.http.routers.mailhog.tls.certresolver=letsencrypt"

  # ==========================================
  # CLOUDFLARE TUNNEL - External Access
  # ==========================================
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: flutterpos-cloudflared
    restart: unless-stopped
    # Use explicit config path so the container picks up local ingress rules
    command: ["tunnel", "--config", "/etc/cloudflared/config.yml"]
    # Removed TUNNEL_TOKEN to use local config instead of remote
    volumes:
      - ./cloudflared-config.yml:/etc/cloudflared/config.yml:ro
      - ./cert.json:/etc/cloudflared/cert.json:ro
      - cloudflared_config:/home/nonroot/.cloudflared
    networks:
      - proxy
      - appwrite
    # Temporarily removed sysctls due to permission issues
    # sysctls:
    #   - net.core.rmem_max=8388608
    #   - net.core.rmem_default=262144
    #   - net.core.wmem_max=8388608
    #   - net.core.wmem_default=262144
    depends_on:
      - traefik
      
  # ==========================================
  # FLUTTERPOS SYNC API - small HTTP API for frontend sync
  # This runs the example Dart server at examples/rabbitmq/backend_sync_api.dart
  # and exposes /api/v1/sync endpoints.
  # ==========================================
  flutterpos-sync-api:
    build:
      context: ./sync_api
    container_name: flutterpos-sync-api
    restart: unless-stopped
    environment:
      - VALID_LICENSE_KEY=EXTRO-LIFE-ABC123
      - PORT=8080
    networks:
      proxy:
      appwrite:
        ipv4_address: 172.20.0.15
    # labels:  # Disabled to avoid conflicts with Appwrite backend routing

volumes:
  # Appwrite volumes
  appwrite_uploads:
  appwrite_cache:
  appwrite_config:
  appwrite_certificates:
  appwrite_functions:
  appwrite_mariadb:
  appwrite_redis:
  appwrite_influxdb:
  appwrite_minio:

  # Nextcloud volumes
  nextcloud_db:
  nextcloud_data:

  # RabbitMQ volumes
  rabbitmq_data:

  # Traefik volumes
  traefik_letsencrypt:

  # Cloudflare Tunnel volumes
  cloudflared_config:

networks:
  proxy:
    driver: bridge
  appwrite:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  nextcloud:
    driver: bridge
  rabbitmq:
    driver: bridge
