version: '3.8'

services:
  # Super Admin API (production)
  super-admin-api:
    image: docker-super-admin-api:latest
    container_name: super-admin-api
    restart: unless-stopped
    networks:
      - appwrite
      - api-network
    environment:
      - PORT=3001
      - NODE_ENV=production
      - APPWRITE_ENDPOINT=http://appwrite-api:80/v1
      - APPWRITE_PROJECT_ID=6940a64500383754a37f
      - APPWRITE_API_KEY=${APPWRITE_API_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - SUPER_ADMIN_API_KEY=${SUPER_ADMIN_API_KEY}
      - ALLOWED_ORIGINS=https://backend.extropos.org,https://api.extropos.org
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.extropos.service=super-admin-api"
      - "com.extropos.environment=production"

  # NGINX Reverse Proxy
  api-nginx:
    image: nginx:alpine
    container_name: api-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./api-nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
      - ./nginx-logs:/var/log/nginx
    networks:
      - api-network
    depends_on:
      - super-admin-api
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.extropos.service=api-nginx"
      - "com.extropos.environment=production"

  # Certbot for SSL certificates
  certbot:
    image: certbot/certbot:latest
    container_name: api-certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    labels:
      - "com.extropos.service=certbot"
      - "com.extropos.environment=production"

networks:
  appwrite:
    external: true
  api-network:
    driver: bridge
    name: api-network
