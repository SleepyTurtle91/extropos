name: Generate golden images

on:
  workflow_dispatch:
    inputs:
      commit_back:
        description: 'If set to true and GITHUB_TOKEN has push permission, the workflow will commit generated goldens.'
        required: false
        default: 'false'
  # Allow a controlled push trigger when a maintainer creates the file
  # ci/generate-goldens.trigger on this branch. This is a safe way to start
  # the golden generation from a developer machine (no automatic commit back).
  push:
    branches:
      - responsive/layout-fixes
    paths:
      - 'ci/generate-goldens.trigger'

jobs:
  generate-goldens:
    name: Generate and upload goldens
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: stable

      - name: Install dependencies
        run: |
          flutter pub get

      - name: Initialize sqflite ffi (create working dirs)
        run: |
          # ensure tests that use sqflite_common_ffi can create temporary DBs
          mkdir -p /tmp/flutterpos_goldens

      - name: Run golden tests and update goldens
        run: |
          set -e
          flutter test --update-goldens test/goldens/large_breakpoints_golden_test.dart

      - name: Collect generated goldens
        run: |
          ls -lah test/goldens || true

      - name: Upload goldens as artifact
        uses: actions/upload-artifact@v4
        with:
          name: golden-images
          path: |
            test/goldens/retail_2560x1440.png
            test/goldens/retail_3840x2160.png
            test/goldens/kitchen_2560x1440.png
            test/goldens/kitchen_3840x2160.png

      - id: commit_and_push
        name: Optionally commit goldens to a new branch and open PR
        if: ${{ inputs.commit_back == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a new branch name for generated goldens and commit files there.
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Create a stable branch name per run (use environment variables available in the runner)
          # GITHUB_RUN_ID and GITHUB_SHA are available; use the first 7 chars of SHA for readability.
          BRANCH_NAME="goldens/generated-${GITHUB_RUN_ID}-${GITHUB_SHA:0:7}"
          echo "Creating branch $BRANCH_NAME"
          git checkout -b "$BRANCH_NAME"

          # Add any generated PNGs and commit them
          git add test/goldens/*.png || true
          if git diff --cached --quiet; then
            echo "No golden changes to commit"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore(goldens): add/update large-screen golden images" || true
            git push origin "$BRANCH_NAME"
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
            echo "Pushed changes to $BRANCH_NAME"
          fi

      - name: Create PR for generated goldens (if committed)
        if: ${{ inputs.commit_back == 'true' && steps.commit_and_push.outputs.changes == 'true' }}
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(goldens): add/update large-screen golden images'
          title: 'chore(goldens): generated large-screen goldens (CI)'
          body: |
            This pull request contains golden images generated by the CI workflow (2K & 4K baselines).
            Please review the images in `test/goldens/` and merge if they look good.
          base: responsive/layout-fixes
          head: ${{ steps.commit_and_push.outputs.branch }}
