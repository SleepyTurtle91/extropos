name: Deploy RabbitMQ with TLS

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Public domain e.g. pos.mycompany.stream'
        default: 'pos.mycompany.stream'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install certbot and Cloudflare plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y certbot python3-certbot-dns-cloudflare

      - name: Obtain certificates via Certbot (Cloudflare DNS plugin)
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          DOMAIN=${{ github.event.inputs.domain }}
          chmod +x docker/rabbitmq/setup_certbot_cloudflare.sh
          CF_API_TOKEN=${{ secrets.CF_API_TOKEN }} docker/rabbitmq/setup_certbot_cloudflare.sh $DOMAIN
          ls -la docker/rabbitmq/certs || true

      - name: Copy certs to remote host
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          source: "docker/rabbitmq/certs/*"
          target: "/home/${{ secrets.SERVER_USER }}/certs/"

      - name: Copy docker-compose file
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          source: "docker/rabbitmq/docker-compose-tls.yml"
          target: "/home/${{ secrets.SERVER_USER }}/rabbitmq-docker-compose.yml"

      - name: Deploy on remote host (restart RabbitMQ)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            cd /home/${{ secrets.SERVER_USER }}
            mkdir -p rabbitmq/certs
            
            # Move certs to proper location
            cp -r certs/* rabbitmq/certs/ || true
            
            # Move docker-compose file
            cp rabbitmq-docker-compose.yml rabbitmq/docker-compose-tls.yml || true
            
            # Deploy RabbitMQ
            cd rabbitmq
            docker compose -f docker-compose-tls.yml down || true
            docker compose -f docker-compose-tls.yml up -d --build
            
            # Wait for startup
            sleep 10
            
            # Verify deployment
            docker compose -f docker-compose-tls.yml ps
            echo "RabbitMQ deployed with TLS on ${{ github.event.inputs.domain }}"
            echo "AMQPS: 5671, Web-STOMP: 15674, Management: 15672"

