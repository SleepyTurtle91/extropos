name: Renew RabbitMQ Certs
on:
  schedule:
    - cron: '0 3 * * *' # run daily at 03:00
  workflow_dispatch: {}

jobs:
  renew:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install certbot and plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y certbot python3-certbot-dns-cloudflare
      - name: Renew certs and copy to remote
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          chmod +x docker/rabbitmq/renew_certbot_cloudflare.sh
          CF_API_TOKEN=${{ secrets.CF_API_TOKEN }} docker/rabbitmq/renew_certbot_cloudflare.sh pos.mycompany.stream
      - name: Deploy renewed certs to remote host
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          source: 'docker/rabbitmq/certs/*'
          target: '/home/${{ secrets.SERVER_USER }}/certs/'
      - name: Run remote docker compose (reload)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            sudo docker compose -f /home/${{ secrets.SERVER_USER }}/docker-compose-rabbitmq.yml restart rabbitmq
